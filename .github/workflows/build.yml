name: Build & Release Sysroot

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
    branches:
      - "main"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ❌ 删除这一步，因为 build.sh 里已经手动处理了 QEMU 和 binfmt
      # - name: Set up QEMU
      #   uses: docker/setup-qemu-action@v3
      #   ...

      - name: Run Build Script
        run: |
          echo "1. Giving permission..."
          chmod +x scripts/build.sh
          
          echo "2. Running script now... (This will take time)"
          # 这个脚本会自动搞定 QEMU 安装、构建、生成两个 tar.gz
          ./scripts/build.sh

      # Upload Artifact (供调试或非 Release 分支下载)
      - name: Upload Artifact (Manual/Branch Build)
        if: (!startsWith(github.ref, 'refs/tags/'))
        uses: actions/upload-artifact@v4
        with:
          name: loongarch-sysroot-debug
          # ✅ 这里会自动抓取所有生成的 .tar.gz 文件
          path: ./*.tar.gz
          if-no-files-found: error
          retention-days: 7

      # Release (正式发布)
      - name: Create Release and Upload Asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: LoongArch Sysroot ${{ github.ref_name }}
          # ✅ 这里也会自动把两个文件都上传到 Release 页面
          files: ./*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
