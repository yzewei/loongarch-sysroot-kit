name: Build & Release Sysroot (Disabled)

# Disabled: superseded by AOSC-only workflow.
on: []

permissions:
  contents: write

env:
  OPENSSL_VERSION: "3.2.2"
  GLIB_VERSION: "2.78.3"

jobs:
  build-release:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: loongarch64

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install binfmt (loong64)
        run: |
          docker run --privileged --rm ghcr.io/loong64/tonistiigi/binfmt --uninstall qemu-*
          docker run --privileged --rm ghcr.io/loong64/tonistiigi/binfmt --install all

      - name: Build Source Artifacts (OpenSSL + GLib)
        run: |
          echo "0. Build source artifacts first..."
          chmod +x scripts/build_src_artifacts.sh
          OPENSSL_VERSION="${OPENSSL_VERSION}" GLIB_VERSION="${GLIB_VERSION}" SRC_BUILDS="openssl glib" ./scripts/build_src_artifacts.sh

      - name: Run Debian Build
        run: |
          echo "1. Giving permission..."
          chmod +x scripts/build.sh
          
          echo "2. Running script now... (This will take time)"
          # 这个脚本会自动搞定 QEMU 安装、构建、生成两个 tar.gz
          DEB_SRC_BUILD_ARTIFACTS=0 ./scripts/build.sh

      - name: Run OpenCloudOS Stream Build (in loong64 container)
        run: |
          echo "Running OpenCloudOS Stream build in loong64 container..."
          chmod +x scripts/build_ocs.sh
          docker run --rm --platform=linux/loong64 --entrypoint /bin/bash \
            -v "$PWD:/work" -w /work \
            -e BASH_ENV=/dev/null \
            -e ENV=/dev/null \
            -e OCS_IN_CONTAINER=1 \
            -e OCS_USE_DOCKER=0 \
            -e OCS_GLIBC_FROM_DEBIAN=1 \
            -e DEBIAN_SYSROOT_DIR=/work/sysroot-loong64 \
            -e OCS_OPENSSL_VERSION="$OPENSSL_VERSION" \
            -e OCS_GLIB_VERSION="$GLIB_VERSION" \
            -e OCS_SRC_USE_ARTIFACTS=1 \
            -e OCS_SRC_ARTIFACTS_DIR="/work/src-libs/openssl-$OPENSSL_VERSION" \
            -e OCS_GLIB_ARTIFACTS_DIR="/work/src-libs/glib-$GLIB_VERSION" \
            -e OCS_SRC_BUILD_ARTIFACTS=0 \
            -e OCS_DOCKER_PLATFORM=linux/loong64 \
            -e OCS_DOCKER_IMAGE=ghcr.io/loong64/opencloudos:9.4-toolbox-20251019 \
            ghcr.io/loong64/opencloudos:9.4-toolbox-20251019 \
            --noprofile --norc -c "./scripts/build_ocs.sh"

      # Upload Artifact (供调试或非 Release 分支下载)
      - name: Upload Artifact (Manual/Branch Build)
        if: (!startsWith(github.ref, 'refs/tags/'))
        uses: actions/upload-artifact@v4
        with:
          name: loongarch-sysroot-bundle
          # ✅ 这里会自动抓取所有生成的 .tar.gz 文件
          path: ./*.tar.gz
          if-no-files-found: error
          retention-days: 7

      # Release (正式发布)
      - name: Create Release and Upload Asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: LoongArch Sysroot ${{ github.ref_name }}
          # ✅ 这里也会自动把两个文件都上传到 Release 页面
          files: ./*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
